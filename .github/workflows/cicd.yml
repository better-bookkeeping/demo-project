# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: CI/CD
on:
  push: # Runs on pushes to any branch
  pull_request:
  workflow_dispatch: # Allows manual triggering

permissions:
  contents: read
  packages: write # to publish Docker images

jobs:
  commitlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install commitlint
        run: bun install -D @commitlint/cli @commitlint/config-conventional
      - name: Validate current commit (last commit) with commitlint
        if: github.event_name == 'push'
        run: bunx commitlint --last --verbose
      - name: Validate PR commits with commitlint
        if: github.event_name == 'pull_request'
        run: bunx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Generate Prisma client
        run: bun run generate
      - name: Generate route tree
        run: bunx tsr generate
      - name: Run typecheck
        run: bun run typecheck

  e2e:
    runs-on: ubuntu-latest
    needs: [commitlint, typecheck]
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: demo_project
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/demo_project
      VITE_ENVIRONMENT: test
      NODE_ENV: test
      COOKIE_SECRET: test-secret
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Generate Prisma client
        run: bun run generate
      - name: Generate route tree
        run: bunx tsr generate
      - name: Apply migrations
        run: bunx prisma migrate deploy
      - name: Install Playwright browsers
        run: bunx playwright install --with-deps
      - name: Run e2e tests
        run: bun run test

  build-and-push:
    runs-on: ubuntu-latest
    needs: [commitlint, typecheck, e2e]
    if: >
      github.event_name == 'push' && (
        github.ref == 'refs/heads/main' ||
        github.ref == 'refs/heads/test' ||
        github.ref == 'refs/heads/staging'
      ) || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set environment tags and node environment
        id: env-tags
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "branch_tag=main" >> $GITHUB_OUTPUT
            echo "env_tag=production" >> $GITHUB_OUTPUT
            echo "node_env=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/test" ]]; then
            echo "branch_tag=test" >> $GITHUB_OUTPUT
            echo "env_tag=test" >> $GITHUB_OUTPUT
            echo "node_env=test" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "branch_tag=staging" >> $GITHUB_OUTPUT
            echo "env_tag=staging" >> $GITHUB_OUTPUT
            echo "node_env=production" >> $GITHUB_OUTPUT
          fi
      - name: Normalize image name
        id: image-name
        run: echo "repo=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          secrets: |
            "github_token=${{ secrets.GITHUB_TOKEN }}"
          target: production
          push: true
          build-args: |
            NODE_ENV=${{ steps.env-tags.outputs.node_env }}
          tags: |
            ${{ github.ref == 'refs/heads/main' && format('ghcr.io/{0}:latest', steps.image-name.outputs.repo) || '' }}
            ghcr.io/${{ steps.image-name.outputs.repo }}:${{ github.sha }}
            ghcr.io/${{ steps.image-name.outputs.repo }}:${{ steps.env-tags.outputs.branch_tag }}
            ghcr.io/${{ steps.image-name.outputs.repo }}:${{ steps.env-tags.outputs.env_tag }}
